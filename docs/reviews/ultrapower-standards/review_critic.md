# Critic Review: ultrapower 全链路规范体系 PRD

> **评审者**: The Critic
> **评审日期**: 2026-02-26
> **PRD 版本**: 0.1 (Draft)
> **评分**: 4 / 10

---

## 总体判定

**Reject** — 当前草稿存在多个严重阻碍，不具备进入实现阶段的条件。核心问题是：PRD 描述的是"规范文档"这一交付物，但对规范本身的内容几乎没有任何实质性定义，导致验收标准无法验证、实现者无从下手。

---

## 1. Security Audit（安全审计）

### [HIGH] 状态文件路径遍历风险 — Fail

PRD 第 3.1 节要求制定"状态文件读写规范"，但完全没有提及路径安全。

实际代码中，`.omc/state/` 下的文件名由 `mode` 参数直接拼接（如 `{mode}-state.json`）。若 `mode` 值来自用户输入或 hook 注入，存在路径遍历攻击面：

```
mode = "../../.claude/settings"
=> 写入路径: .omc/state/../../.claude/settings-state.json
```

PRD 未要求规范中包含输入校验或路径白名单策略。这是一个被完全忽视的安全边界。

### [HIGH] Hook 命令注入面未定义信任边界 — Fail

`hooks.json` 中所有 hook 均以 `async: false` 同步执行，且 matcher 为空字符串（匹配所有工具调用）。PRD 的 Hook 执行顺序规范中没有要求定义：

- hook 脚本的执行权限边界
- hook 输入数据的消毒（sanitization）策略
- 恶意或损坏的 hook 脚本导致整个 Claude 会话阻塞的降级方案

`bridge-normalize.ts` 中提到了"严格白名单过滤"，但 PRD 没有要求将此策略形式化为规范，也没有要求覆盖所有 hook 类型（当前仅覆盖 permission-request、setup、session-end 三类）。

### [MEDIUM] 状态文件无加密，敏感上下文明文存储 — Conditional Fail

`.omc/state/` 下的 `agent-replay-*.jsonl` 文件包含完整的 agent 对话历史，可能含有代码、密钥片段、用户指令等敏感信息。PRD 的"状态文件读写规范"仅关注并发锁，未要求规范中包含：

- 敏感字段识别和脱敏策略
- 文件权限设置（如 chmod 600）
- 数据保留期限和清理策略

---

## 2. Edge Case Analysis（边缘场景分析）

### [CRITICAL] Hook 失败的级联效应未定义

PRD 的 Hook 执行顺序规范（P0-1）定义了正常时序，但完全没有覆盖以下场景：

- `PreToolUse` hook 超时或崩溃 → Claude 是否继续执行工具调用？
- `PostToolUse` hook 写状态文件失败 → 状态是否回滚？下次读取会得到什么？
- `Stop` hook 执行中 Claude 进程被强制终止 → 临时状态文件是否泄漏？

实际的 `hooks.json` 中没有超时配置，没有重试策略，没有 fallback。PRD 要求制定的规范如果不覆盖这些场景，规范本身就是不完整的。

### [CRITICAL] 状态文件损坏场景完全缺失

PRD 提到"状态文件并发读写冲突"是已知问题，但规范要求仅停留在"禁止并发写入"这一预防层面。没有要求定义：

- 检测到损坏 JSON 时的恢复流程
- 部分写入（写到一半进程崩溃）的检测和修复
- 状态文件版本不兼容时的迁移路径

当前 `.omc/state/` 下存在 `last-tool-error.json`，说明错误状态已经在被持久化，但没有对应的清理和恢复规范。

### [HIGH] Agent 生命周期状态机的死状态

PRD 图 4.2 定义的状态机存在逻辑漏洞：

```
RUNNING --> ERROR : 异常/超时
ERROR --> SHUTDOWN : 错误处理完成
```

问题：如果"错误处理"本身也失败了，状态机卡在 `ERROR` 状态，没有强制退出路径。这是一个死状态（dead state）。此外：

- `WAITING` 状态没有超时转换，agent 可以永久等待用户输入
- `IDLE` 状态没有最大存活时间，资源永不释放
- 没有定义 `ZOMBIE` 状态（进程已退出但状态文件未清理）

### [HIGH] 并发写入"禁止"策略的执行机制缺失

P0-2 要求"禁止并发写入同一状态文件"，但 PRD 没有说明这个禁止是如何被强制执行的：

- 是文件系统锁（flock）？
- 是应用层乐观锁（版本号 CAS）？
- 是进程间信号量？

在 Windows 平台（当前开发环境为 Windows 11）上，`flock` 语义与 Unix 不同，Node.js 的文件锁行为存在已知差异。PRD 完全没有提及跨平台兼容性。

### [MEDIUM] Skill 决策树的歧义输入处理

AC-02 要求新用户 5 分钟内选出正确 skill，但决策树（图 4.1）没有覆盖：

- 用户输入同时匹配多个 skill 触发词时的优先级
- 用户输入不匹配任何分支时的 fallback 路径
- `autopilot` 和 `ultrapilot` 互斥规则在决策树中没有体现


---

## 3. Logical Consistency（逻辑一致性）

### [CRITICAL] PRD 是"规范的规范"，但没有规范内容

这是最根本的逻辑问题。PRD 的交付物是"规范文档"，但 PRD 本身只定义了规范文档的名称和存放路径，没有定义规范的实质内容。

以 P0-2"状态文件读写规范"为例，PRD 只说"明确读写锁策略，禁止并发写入"，但没有回答：

- 用什么锁机制？（文件锁 / 内存锁 / 数据库事务）
- 锁的粒度是什么？（文件级 / 字段级）
- 锁超时时间是多少？
- 死锁检测和解除策略是什么？

这意味着实现者拿到这份 PRD 后，仍然需要自行设计所有关键决策。PRD 没有减少任何歧义。

### [HIGH] 验收标准 AC-01 与 AC-04 存在重叠且均不可验证

AC-01："并发场景有明确处理指引" — 验证方法是"检查 P0 规范是否覆盖并行 agent 写同一状态文件的场景"。

AC-04："三类 BUG 来源均有对应规范" — 验证方法是"逐一映射：运行时 BUG → P0"。

两者都在验证"P0 规范是否存在"，而不是验证"P0 规范是否有效"。一份只写了"禁止并发写入"四个字的文档也能通过这两个 AC。这不是验收标准，是存在性检查。

### [HIGH] AC-02 的测量方法不可重复执行

"新用户 5 分钟内选出正确 skill，准确率 ≥ 80%"需要用户测试。但 PRD 没有定义：

- "新用户"的定义（完全没用过 ultrapower？还是没用过 v5.x？）
- "正确 skill"由谁判定？（存在主观性）
- 3 个典型场景是哪 3 个？（不同场景难度差异极大）
- 测试在什么环境下进行？（有无文档辅助？）

这个 AC 在当前形式下无法被客观验证，也无法被重复执行。

### [HIGH] P0 与 P2 存在实现顺序矛盾

P0 要求制定"Hook 执行顺序规范"，P2 才要求制定"Hook 标准模板"。

但实际上，如果没有标准模板，就无法判断现有 35 个 hook 是否符合规范；如果现有 hook 不符合规范，P0 的规范就是在描述一个不存在的理想状态。

正确的顺序应该是：先审计现有实现 → 提炼规范 → 制定模板。PRD 跳过了"审计现有实现"这一步。

### [MEDIUM] 非功能需求"向后兼容"与 P0 目标存在潜在冲突

非功能需求要求"P0/P1 规范不得破坏现有 v5.0.x 用户的使用习惯"。

但 P0 的目标是修复已知的并发 BUG（2026-02-12 Race Condition）。修复并发 BUG 通常意味着改变状态文件的读写行为，这可能改变现有用户依赖的时序。

PRD 没有分析这两个目标之间的张力，也没有提供解决方案。

### [MEDIUM] "三类 BUG 来源"与 MVP 范围的映射不完整

背景章节定义了三类问题：运行时 BUG、使用混乱、贡献无序。但 P0 只覆盖了"运行时 BUG"中的三个子项，没有说明是否已穷举所有运行时 BUG 来源。

实际上，从 hooks 目录结构来看，还存在以下未被 P0 覆盖的运行时风险：

- `recovery` hook：崩溃恢复逻辑的规范缺失
- `pre-compact` / `preemptive-compaction`：上下文压缩时序的规范缺失
- `subagent-tracker`：子 agent 追踪状态的一致性规范缺失

---

## 4. 范围蔓延风险（Scope Creep Analysis）

### [HIGH] P2 模板工作量被严重低估

P2 要求制定 Skill、Agent、Hook 三类标准模板。但当前系统规模是：

- 49 个 agent
- 35 个 hook
- 20+ 个 skill

制定模板需要先对现有实现进行全面审计，提炼共性，识别差异，处理例外情况。这不是"写几个模板文件"的工作量，而是一次系统性的架构梳理。PRD 将其列为 P2（可选），但实际上它是 P0 规范能否落地的前提条件。

### [MEDIUM] "贡献检查清单"隐含了 CI 工具链需求

P2-10 要求"新增任何组件前必须通过的 checklist（含测试要求和版本兼容性验证）"。

但如果 checklist 只是一份 Markdown 文档，没有自动化执行，它的实际效果接近于零（人工检查清单在工程实践中的遵守率极低）。

PRD 在第 7 节明确将"自动化规范检查工具"和"规范合规性 CI 检查"列为 v2 延期项。这意味着 v1 的 checklist 是一份没有执行保障的文档，其价值存疑。

---

## 5. 缺失的关键内容

以下内容在 PRD 中完全缺失，但对于一个规范体系 PRD 是必须的：

| 缺失项 | 影响 |
| --- | --- |
| 规范的版本控制策略 | 规范本身如何演进？旧版规范如何废弃？ |
| 规范冲突解决机制 | 当 P0 规范与 P1 规范产生矛盾时，谁优先？ |
| 规范的强制执行机制 | 没有工具链保障的规范是建议，不是规范 |
| 现有违规的处理策略 | 35 个 hook 中有多少不符合待制定的规范？如何处理？ |
| 规范的受众定义 | 规范是给 AI agent 读的还是给人类开发者读的？两者格式要求完全不同 |
| Windows 平台特殊处理 | 当前开发环境是 Windows 11，文件锁、路径分隔符等行为与 Unix 不同 |

---

## Conclusion（结论）

**判定: Reject**

### Major Blockers（严重阻碍）

1. **PRD 没有定义规范内容，只定义了规范的名称** — 实现者无法从这份 PRD 推导出任何具体的规范条目。必须在 PRD 中至少给出每个规范文档的核心条目草稿。

2. **状态文件安全边界完全缺失** — 路径遍历风险、敏感数据明文存储、hook 命令注入面均未被识别，规范体系不能在安全问题上留白。

3. **验收标准不可验证** — AC-01 和 AC-04 是存在性检查而非质量检查；AC-02 缺乏可重复执行的测量方法。必须重写所有 AC，使其具备明确的通过/失败判定条件。

4. **Agent 生命周期状态机存在死状态** — `ERROR` 状态没有强制退出路径，`WAITING` 状态没有超时，这是会在生产环境中触发的设计缺陷，不能进入实现。

5. **跨平台兼容性（Windows）完全未考虑** — 文件锁策略在 Windows 上的行为与 Unix 不同，这是当前开发环境的直接风险，必须在 P0 规范中明确处理。

### 修复建议（按优先级）

1. 为每个 P0 规范条目补充至少 3 条具体规则草稿（不是描述，是可执行的规则）
2. 重写 AC-01/AC-04 为可量化的质量指标（如：规范覆盖已知 BUG 列表中 N 个场景）
3. 在 P0 中增加"安全边界"章节，覆盖路径校验和 hook 输入消毒
4. 修复状态机死状态，为 `ERROR` 和 `WAITING` 增加超时强制转换
5. 在非功能需求中增加 Windows 平台兼容性要求，并在 P0 锁策略中给出跨平台方案
